---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

## About the Method

The methodology implemented in this package is developed in Ferrer et al. (2025). Traditional connectedness models (Diebold & Yilmaz, 2012) capture interdependence at the mean, overlooking asymmetries in how shocks propagate. Likewise, standard quantile-based methods (e.g., Ando et al., 2022) focus on average shocks affecting conditional quantiles rather than direct tail interactions.

The proposed framework directly models tail-to-tail spillovers, offering a more accurate representation of asymmetric interdependence. This design mitigates the upward bias found in some quantile connectedness indices (Caporin et al., 2023).

> **Ferrer, R., Shahzad, S. J. H., Furió, D., & Benammar, R. (2025).**  
> *Systemic Risk in the Tails: Contemporaneous Transmission and Spillover Dynamics in European Renewable Energy Equities.*  Submitted for publication.

Please cite the paper once published and this R package.

# Quantile Connectedness

**QuantileConnectedness** provides tools to compute, decompose, and visualize R² decomposed connectedness measures based on **quantile correlation coefficients** (Choi & Shin, 2022), extending the approaches of Baur & Hoang (2023) and Balli et al. (2023).

The package includes:

- `Qcor()` – quantile correlation matrices  
- `R2ConnectednessQ()` – R² decomposed connectedness (full sample or rolling)  
- `net_plot()` – network visualization (PMFG or thresholded)  
- `renewable_residuals` – daily residuals for 26 European renewable-energy firms (2017–2025)

```{r, include = FALSE}
devtools::load_all()
# Global knitr options: make figures show on GitHub
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%",
  dpi = 150
)
set.seed(1)
```

## Installation

```r
# install.packages("devtools")
devtools::install_github("https://github.com/syedjawadshahzad/QuantileConnectedness")
library(QuantileConnectedness)   
```
---

## Figure 1. Lower-tail R2 decomposed connectedness networks among European enewable energy firms
## Full-sample R² connectedness (q = 0.05, nlag = 1)

```{r}
#library(ConnectednessApproach)
R2conL <- R2ConnectednessQ(
  renewable_residuals,
  window.size = NULL,    
  nlag = 1,
  quantile = TRUE,
  q = 0.05,
  method = "pearson",
  shrink = TRUE,
  progbar = FALSE
)
```

We first need to set the node labels and group firms into their sectors.

```{r}
Cnames <- colnames(renewable_residuals)
groups <- list(Renewable = 1:7,
               Solar = 8:15,
               Wind = 16:26)
```

### Network plot - Overall connectedness
```{r fig.height=6, fig.width=6}
go <- net_plot(
  R2conL$TABLE$Overall, Cnames,
  layout = "spring",
  groups = groups, div = 5,
  node.size = 35, edge = 3,
  pie.colour = c("black","white")
)
```

### Network plot - Contemporaneous connectedness
```{r fig.height=6, fig.width=6}
gc <- net_plot(
  R2conL$TABLE$Contemporaneous, Cnames,
  layout = "spring",
  groups = groups, div = 5,
  node.size = 35, edge = 3,
  pie.colour = c("black","white")
)
```

### Network plot - Lag connectedness
```{r fig.height=6, fig.width=6}
gl <- net_plot(
  R2conL$TABLE$Lagged, Cnames,
  layout = "spring",
  groups = groups, div = 8,
  node.size = 35, edge = 2,
  pie.colour = c("black","white")
)
```

Notes: This figure plots the R2-decomposed connectedness networks among the stock returns of European renewable energy companies at the lower tail of the return distribution (τ = 0.05). The networks are constructed based on the overall connectedness, as well as its contemporaneous and lagged components. A total of 26 European renewable energy companies, belonging to the wind energy, solar energy, and renewable fuel sub-sectors, are considered. Each node represents a company, while edges denote return spillovers between firms. Node size is proportional to the sum of TO and FROM spillovers of that node with all others. The aureole color around nodes  differentiates net transmitters (black) from net receivers (white) of spillovers. Furthermore, the node color corresponds to sub-sector classifications. Specifically, green nodes indicate wind energy companies, while blue and orange nodes represent solar energy and renewable fuels companies, respectively. The arrow’s orientation indicates the direction of return spillovers, and arrow thickness represents spillover intensity. To enhance interpretability, only the top 20% largest values of pairwise spillovers are displayed.

---

## Figure 2. Time-varying lower tail total connectedness index among European renewable energy companies


```{r , eval=FALSE}
dca <- R2ConnectednessQ(
  renewable_residuals,
  window.size = 200,
  nlag = 1,
  quantile = TRUE,
  q = 0.05,
  method = "pearson",
  shrink = TRUE,
  progbar = TRUE
)
```

```{r , echo=FALSE}
data(dca_w200_q005)
dca <- dca_w200_q005
```

```{r}
TCI <- dca$TCI
head(TCI)
```

```{r}
df <- cbind.data.frame(as.Date(rownames(TCI)), TCI[, 1:3, drop = FALSE])
colnames(df) <- c("date", "SOI", "SOIC", "SOIL")
```

```{r, message=FALSE, warning=FALSE, fig.height=5.5}
library(ggplot2)

ymin <- 0; ymax <- 80

mytheme <- theme(
  panel.background = element_rect(fill = "transparent"),
  panel.border     = element_rect(fill = "transparent", color = "black", linewidth = 0.6),
  text             = element_text(size = 13, color = "black"),
  axis.text.x      = element_text(color = "black"),
  axis.text.y      = element_text(color = "black"),
  panel.grid.major = element_line(size = 0.1, colour = "grey75"),
  panel.grid.minor = element_line(size = 0.05, colour = "grey85"),
  legend.position  = "bottom",
  legend.title     = element_blank()
)

g_tci <- ggplot(df, aes(x = date)) +
  geom_line(aes(y = SOI),  color = "blue",  linewidth = 0.9) +
  geom_line(aes(y = SOIC), color = "green", linewidth = 0.9) +
  geom_line(aes(y = SOIL), color = "red",   linewidth = 0.9) +
  theme_minimal() +
  coord_cartesian(ylim = c(ymin, ymax)) +
  labs(y = "Connectedness", x = "Date") +
  scale_x_date(date_breaks = "1 year", date_labels = "%Y") +
  geom_vline(xintercept = as.Date("2020-03-01"), linetype = "dashed") +
  geom_vline(xintercept = as.Date("2021-01-01"), linetype = "dashed") +
  geom_vline(xintercept = as.Date("2022-02-24"), linetype = "dashed") +
  annotate("text", x = as.Date("2019-06-01"), y = ymax - 2,
           label = "COVID-19", size = 3.6, hjust = 0) +
  annotate("text", x = as.Date("2021-01-30"), y = ymin + 5,
           label = "Russia–Ukraine war", size = 3.6, hjust = 0) +
  mytheme

g_tci
```


Notes: This figure illustrates the time-varying overall total connectedness index (blue line), alongside its contemporaneous (green line) and lagged (red line) components, calculated at the extreme lower tail (τ = 0.05) among European renewable energy companies. The analysis spans from January 2, 2017, to January 31, 2025. The total connectedness indices are computed using a rolling window length of 200 trading days with a lag=1. The dates on the x-axis correspond to the final day of each rolling window period.

---

## Portfolio Analysis

Coming soon ...


## References

- Ando, T., Greenwood-Nimmo, M. and Shin, Y. (2022). *Quantile connectedness: Modelling tail behaviour in the topology of financial networks.* Management Science, 68(4), 2401-2431.
- Balli, F., Balli, H. O., Dang, T. H. N., & Gabauer, D. (2023). *Contemporaneous and lagged R2 decomposed connectedness approach: New evidence from the energy futures market.* Finance Research Letters, 57, 104168. 
- Baur, D. G., & Hoang, L. T. (2023). *A Simple Model to Estimate Spillovers and Correlations.* Available at SSRN 4372392.
- Caporin, M., Bonaccolto, G. and Shahzad, S.J.H. (2023). *(Quantile) Spillover Indexes: Simulation-based evidence, confidence intervals and a decomposition.* Forthcoming - Journal of Financial Econometrics. Available at SSRN: https://ssrn.com/abstract=4629224. 
- Choi, J. E., & Shin, D. W. (2022). *Quantile correlation coefficient: a new tail dependence measure.* Statistical Papers, 63(4), 1075-1104.
- Diebold, F.X. and Yilmaz, K. (2012). *Better to give than to receive: Predictive directional measurement of volatility spillovers.* International Journal of Forecasting, 28(1), 57-66.
- Ferrer, R., Shahzad, S. J. H., Furió, D., & Benammar, R. (2025). *Systemic Risk in the Tails: Contemporaneous Transmission and Spillover Dynamics in European Renewable Energy Equities.*


